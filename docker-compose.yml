version: '3'

volumes:
  i2b2-db:
  cometar-repository:
  cometar-provenance:
  auth:
  letsencrypt:

services:
  dwh-proxy:
    container_name:
      dwh.proxy
    # image: ${IMAGE_NAMESPACE}/i2b2/i2b2-proxy:${DWH_VERSION:-latest}
    build:
      context: ./proxy
      dockerfile: Dockerfile
    ports:
      - 80:80
      - 443:443
    volumes:
      - auth:/etc/nginx/auth
      - letsencrypt:/etc/letsencrypt
    env_file:
      - .env
    depends_on:
      - i2b2-web
      - cometar-web

  i2b2-web:
    container_name:
      i2b2.web
    image: ${IMAGE_NAMESPACE}/i2b2/i2b2-web:${I2B2_VERSION:-latest}
    env_file:
      - .env
    depends_on:
      - i2b2-wildfly
  i2b2-wildfly:
    container_name:
      i2b2.wildfly
    image: ${IMAGE_NAMESPACE}/i2b2/i2b2-wildfly:${I2B2_VERSION:-latest}
    env_file:
      - .env
      - .env-secrets
    depends_on:
      - i2b2-database
  i2b2-database:
    container_name:
      i2b2.database
    image: ${IMAGE_NAMESPACE}/i2b2/i2b2-database:${I2B2_VERSION:-latest}
    volumes:
      - i2b2-db:/var/lib/postgresql/data
    env_file:
      - .env
      - .env-secrets
  i2b2-api:
    container_name:
      i2b2.api
    image: ${IMAGE_NAMESPACE}/i2b2/i2b2-api:${I2B2_VERSION:-latest}
    env_file:
      - .env
    depends_on:
      - i2b2-database
  i2b2-meta:
    container_name:
      i2b2.meta
    image: ${IMAGE_NAMESPACE}/i2b2/i2b2-meta:${I2B2_VERSION:-latest}
    volumes:
      - ../i2b2/custom-metadata:/var/translator-custom-metadata:ro
      - ./i2b2meta_user_config.yaml:/config/i2b2meta_user_config.yaml:ro
    ## Attempt to limit resources - not well implemented for docker compose!
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 200M
        reservations:
          cpus: '0.1'
          memory: 50M
    env_file:
      - .env
      - .env-secrets
    depends_on:
      - i2b2-database

  cometar-web:
    container_name:
      cometar.web
    image: ${IMAGE_NAMESPACE}/cometar/cometar-web:${COMETAR_VERSION:-latest}
    env_file:
      - .env
    depends_on:
      - "cometar-rest"
      - "cometar-git"
  cometar-git:
    container_name:
      cometar.git
    image: ${IMAGE_NAMESPACE}/cometar/cometar-git:${COMETAR_VERSION:-DWH_VERSION}
    env_file:
      - .env
    volumes:
      - cometar-repository:/git
    depends_on:
      - "cometar-rest"
  cometar-rest:
    container_name:
      cometar.rest
    image: ${IMAGE_NAMESPACE}/cometar/cometar-rest:${COMETAR_VERSION:-DWH_VERSION}
    volumes:
      - cometar-repository:/update-hook-repository:ro
      - cometar-provenance:/var/lib/cometar/provenance
    depends_on:
      - "cometar-fuseki"
  cometar-fuseki:
    container_name:
      cometar.fuseki
    image: ${IMAGE_NAMESPACE}/cometar/cometar-fuseki:${COMETAR_VERSION:-DWH_VERSION}
